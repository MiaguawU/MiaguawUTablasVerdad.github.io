<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<style>
.contenedor {
  width: 650px;
  height: 650px;
}

#svg {
  width: 100%;
  height: 100%;
  cursor: grab;
}

#svg.dragging {
  cursor: grabbing;
}

svg * {
  pointer-events: visiblePainted;
}
</style>
</head>

<body>

<div class="contenedor">
  <svg id="svg" viewBox="0 0 600 600"></svg>
</div>

<script>
const svg = document.getElementById("svg");
crearMarcadorFlecha(svg);
const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");

const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
marker.setAttribute("id", "arrow");
marker.setAttribute("markerWidth", "10");
marker.setAttribute("markerHeight", "10");
marker.setAttribute("refX", "8");
marker.setAttribute("refY", "5");
marker.setAttribute("orient", "auto");

const arrowPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
arrowPath.setAttribute("d", "M0,0 L10,5 L0,10 Z");
arrowPath.setAttribute("fill", "black");

marker.appendChild(arrowPath);
defs.appendChild(marker);
svg.appendChild(defs);


// ðŸ”¹ grupo raÃ­z (TODO gira)
const root = document.createElementNS("http://www.w3.org/2000/svg", "g");
svg.appendChild(root);

const cx = 300;
const cy = 300;
const r = 250;
const puntos = 20;

// =====================
// CREACIÃ“N DE LOS GRUPOS
// =====================
for (let i = 0; i < puntos; i++) {
  const theta = (2 * Math.PI / puntos) * (i+90) ;
  const deg = theta * 180 / Math.PI;

  const x = cx + r * Math.cos(theta);
  const y = cy + r * Math.sin(theta);

  // ðŸ”¹ Punto del cÃ­rculo
  const punto = crearCirculo(x, y, 3);
  root.appendChild(punto);

  // ðŸ”¹ Grupo radial
  const grupo = document.createElementNS("http://www.w3.org/2000/svg", "g");
  grupo.setAttribute(
    "transform",
    `translate(${x}, ${y}) rotate(${deg})`
  );

  // ðŸ”¹ Ãrea grande de click (INVISIBLE)
  const hitbox = document.createElementNS("http://www.w3.org/2000/svg", "rect");
  hitbox.setAttribute("x", -5);
  hitbox.setAttribute("y", -25);
  hitbox.setAttribute("width", 50);
  hitbox.setAttribute("height", 50);
  hitbox.setAttribute("fill", "transparent");

  // ðŸ”¹ LÃ­nea
  const linea = document.createElementNS("http://www.w3.org/2000/svg", "line");
  linea.setAttribute("x1", 0);
  linea.setAttribute("y1", 0);
  linea.setAttribute("x2", 10);
  linea.setAttribute("y2", 0);
  linea.setAttribute("stroke", "black");

  // ðŸ”¹ Grupo del texto
  const grupoTexto = document.createElementNS("http://www.w3.org/2000/svg", "g");
  grupoTexto.setAttribute("transform", "translate(25, -11) rotate(90)");

  const textoBase = document.createElementNS("http://www.w3.org/2000/svg", "text");
  textoBase.setAttribute("x", 0);
  textoBase.setAttribute("y", 10);
  textoBase.setAttribute("font-size", "11");
  textoBase.setAttribute("font-family", "monospace");
  textoBase.textContent = `[${i}]`;


  const textoSub = document.createElementNS("http://www.w3.org/2000/svg", "text");
    if(i<10){
  textoSub.setAttribute("x", 19);
  }
  else{
  textoSub.setAttribute("x", 24);
  }
  textoSub.setAttribute("y", 14);
  textoSub.setAttribute("font-size", "8");
  textoSub.setAttribute("font-family", "monospace");
  textoSub.textContent = `${puntos}`;

  grupoTexto.appendChild(textoBase);
  grupoTexto.appendChild(textoSub);


  grupo.appendChild(hitbox);
  grupo.appendChild(grupoTexto);
  root.appendChild(grupo);


  // ðŸ”¹ Click para colorear
  grupo.addEventListener("click", e => {
    e.stopPropagation();
    toggleGrupoColor(grupo);
  });
}

  root.appendChild(lazoEn(2));//si hay quitar linea pequeÃ±a 
  root.appendChild(flechaEntre(0, 3));
  root.appendChild(lineaEntre(9, 8));

// =====================
// ROTACIÃ“N CON EL MOUSE
// =====================
let dragging = false;
let anguloInicial = 0;
let rotacionActual = 0;

svg.addEventListener("mousedown", e => {
  dragging = true;
  svg.classList.add("dragging");
  anguloInicial = obtenerAngulo(e) - rotacionActual;
});

svg.addEventListener("mousemove", e => {
  if (!dragging) return;
  rotacionActual = obtenerAngulo(e) - anguloInicial;
  root.setAttribute(
    "transform",
    `rotate(${rotacionActual} ${cx} ${cy})`
  );
});

svg.addEventListener("mouseup", () => {
  dragging = false;
  svg.classList.remove("dragging");
});

svg.addEventListener("mouseleave", () => {
  dragging = false;
  svg.classList.remove("dragging");
});

function obtenerAngulo(e) {
  const rect = svg.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  return Math.atan2(my - cy, mx - cx) * 180 / Math.PI;
}

// =====================
// HELPERS
// =====================
function crearCirculo(x, y, r) {
  const c = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  c.setAttribute("cx", x);
  c.setAttribute("cy", y);
  c.setAttribute("r", r);
  c.setAttribute("fill", "black");
  return c;
}

function toggleGrupoColor(grupo) {
  const activo = grupo.getAttribute("data-activo") === "1";
  grupo.setAttribute("data-activo", activo ? "0" : "1");

  grupo.querySelectorAll("*").forEach(el => {
    if (el.hasAttribute("stroke"))
      el.setAttribute("stroke", activo ? "black" : "red");
    if (el.tagName === "text")
      el.setAttribute("fill", activo ? "black" : "red");
  });
}
function crearMarcadorFlecha(svg) {
  const defs = document.createElementNS("http://www.w3.org/2000/svg", "defs");

  const marker = document.createElementNS("http://www.w3.org/2000/svg", "marker");
  marker.setAttribute("id", "arrow");
  marker.setAttribute("markerWidth", "10");
  marker.setAttribute("markerHeight", "10");
  marker.setAttribute("refX", "9");
  marker.setAttribute("refY", "5");
  marker.setAttribute("orient", "auto");
  marker.setAttribute("markerUnits", "strokeWidth");

  // ðŸ”¹ FLECHA ABIERTA (opciÃ³n 5)
  const arrowPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
  arrowPath.setAttribute("d", "M2,2 L10,5 L2,8");
  arrowPath.setAttribute("d", "M6,3 L9,5 L5,7");

  arrowPath.setAttribute("fill", "none");
  arrowPath.setAttribute("stroke", "purple");
  arrowPath.setAttribute("stroke-width", ".8");
  arrowPath.setAttribute("stroke-linecap", "round");
  arrowPath.setAttribute("stroke-linejoin", "round");

  marker.appendChild(arrowPath);
  defs.appendChild(marker);
  svg.appendChild(defs);
}

function flechaEntre(i, j) {
  const p1 = puntoPorIndice(i, 0);
  const p2 = puntoPorIndice(j, 0);

  const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
  line.setAttribute("x1", p1.x);
  line.setAttribute("y1", p1.y);
  line.setAttribute("x2", p2.x);
  line.setAttribute("y2", p2.y);
  line.setAttribute("stroke", "blue");
  line.setAttribute("stroke-width", "2");
  
  line.setAttribute("marker-end", "url(#arrow)");

  return line;
}

function crearLazo(radio = 8) {
  const path = document.createElementNS("http://www.w3.org/2000/svg", "path");

  // arco casi circular
  const d = `
    M ${-radio} 0
    A ${radio} ${radio} 0 1 1 ${radio} 0
  `;

  path.setAttribute("d", d);
  path.setAttribute("fill", "none");
  path.setAttribute("stroke", "black");
  path.setAttribute("stroke-width", "1.5");
  path.setAttribute("marker-end", "url(#arrow)");

  return path;
}
function lazoEn(i) {
  const p = puntoPorIndice(i, 0);

  const rLazo = 6;   // tamaÃ±o del lazo
  const offset = 4; // separaciÃ³n del nodo

  // Punto inicial y final (ligeramente distintos)
  const x1 = p.x + offset ;
  const y1 = p.y - offset ;
  const x2 = p.x - offset ;
  const y2 = p.y - offset ;

  const path = document.createElementNS("http://www.w3.org/2000/svg", "path");

  // ðŸ”¹ ARCO GRANDE (â†º)
  const d = `
    M ${x1} ${y1}
    A ${rLazo} ${rLazo} 0 1 1 ${x2} ${y2}
  `;

  path.setAttribute("d", d);
  path.setAttribute("fill", "none");
  path.setAttribute("stroke", "blue");
  path.setAttribute("stroke-width", "2");
  path.setAttribute("marker-end", "url(#arrow)");

  svg.appendChild(path);
  return path;
}

function puntoPorIndice(i, radioExtra = 0) {
  const theta = (2 * Math.PI / puntos) * (i+90) ;
  return {
    x: cx + (r + radioExtra) * Math.cos(theta),
    y: cy + (r + radioExtra) * Math.sin(theta)
  };
}
function lineaEntre(i, j) {
  const p1 = puntoPorIndice(i, 0);
  const p2 = puntoPorIndice(j, 0);

  const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
  line.setAttribute("x1", p1.x);
  line.setAttribute("y1", p1.y);
  line.setAttribute("x2", p2.x);
  line.setAttribute("y2", p2.y);
  line.setAttribute("stroke", "green");
  line.setAttribute("stroke-width", "2");

  return line;
}

</script>

</body>
</html>
